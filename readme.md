# Ufanet Telegram Bot  
**Считывание данных со счётчиков по MQTT → Telegram-бот на Aiogram 3**

Бот позволяет пользователям:
- Подключаться к счётчику по его MAC-адресу (`XXXX:XXXX:XXXX:XXXX`)
- Получать актуальные данные в реальном времени
- Автоматически отключаться при отсутствии активности или по команде

Всё работает в Docker: Mosquitto + Redis + Python-бот — одной командой.

## Особенности
- Aiogram 3 + asyncio
- Подключение к MQTT (Eclipse Mosquitto) с авторизацией
- Хранение активных подписок в Redis (мгновенная отписка)
- Защита от дублирующих подключений
- Полностью контейнеризировано (docker-compose)
- Hot-reload при разработке
- Работает на Windows и Linux


## Быстрый старт (одной командой)

### 1. Клонируй и перейди в папку
```bash
git clone https://github.com/твой-ник/Ufanet-main.git
cd Ufanet-main
```

### 2. Запусти все
```bash
docker-compose up --build
```

### Команды в боте
- /start — главное меню
- Подключиться → ввести MAC-адрес → получить данные
- Отключиться → отписаться от устройства
- /id — узнать свой Telegram ID

> Важно: после подключения бот ждёт данные 60 секунд. Если ничего не приходит — автоматически отключается.

### Для тестирования 
#### Вариант 1 - Через Python-скрипт:
1. Запустите docker-compose up
2. Перейдите в бота и подпишитесь на mac-адрес вида (1234:1234:1234:1234). Имейте ввиду, бот отписывается от mac-адреса по Timeout спустя 60 секунд
3. В файле testingPublish.py замените переменную `topic` на mac адрес на который вы подписались.
4. Запустите в консоли команду:
```bash
python testingPublish.py
```
5. Если все сделано правильно в боте должны отобразиться сообщения вида:
<img width="576" height="622" alt="image" src="https://github.com/user-attachments/assets/434aeae9-3660-41ed-94c2-2e17fc3aa062" />

#### Вариант 2 - Через консоль контейнера
```bash
docker exec -it mqtt mosquitto_pub -t "1223:1441:3451:3161" -m "Тестовое показание: 156.8 кВт·ч" -u ufanet_bot -P supersecret123
```

## Добавление новых пользователей MQTT
```bash
docker exec -it mqtt mosquitto_passwd /mosquitto/config/password новый_логин новый_пароль
```

## Полезные ссылки
- RedisInsight (веб-интерфейс): http://localhost:8001
- MQTT WebSocket (если нужен): ws://localhost:9001

